<!doctype html>
<html>
  <head>
    <title>Live</title>
    <script type="text/javascript" src="../src/barcode.js"></script>
    <script type="text/javascript" src="../src/ean13.js"></script>
    <script type="text/javascript" src="../src/reader.js"></script>
    <script type="text/javascript" src="../src/reader/processor.js"></script>
    <script type="text/javascript" src="../src/reader/detector.js"></script>

  </head>
  <body>
    <!--<input type="button" id="start" value="Start"/>-->
    <!--<input type="button" id="stop" value="Stop"/>-->
    <table>
      <tr>
        <td><strong>Threshold</strong></td>
        <td><label><input type="text" maxwidth="3" disabled="disabled" style="width: 50px" id="threshold"/></td>
      </tr>
    </table>
    <canvas id="canvas"></canvas>
    <video id="video" autoplay="autoplay"></video>
  </body>

  <script type="text/javascript">
    // document.getElementById('start').addEventListener('click', function() {
    //   reader_video.start();
    // });

    // document.getElementById('stop').addEventListener('click', function() {
    //   reader_video.stop();
    // });

    if(false) {
      var canvas = document.getElementById('canvas');
      canvas.style.border = "1px solid blue";
      var context = canvas.getContext('2d');
      var image = new Image();
      // image.src = 'img/test1.png';
      image.src = 'img/ean13.svg';
      image.onload = function(){
        canvas.width = image.width;
        canvas.height = image.height;

        context.drawImage(image, 0, 0);

        var reader_canvas = new barcode.reader({
          'source': canvas,
          'symbology': 'ean13'
        });

        reader_canvas.start();
      };

    }

    var streaming = false;
    var video = document.getElementById('video');

    navigator.getMedia = (
      navigator.getUserMedia ||
      navigator.webkitGetUserMedia ||
      navigator.mozGetUserMedia ||
      navigator.msGetUserMedia
    );

    navigator.getMedia(
      {
        'video': {
          "mandatory": {
             "minWidth": "320",
             "minHeight": "180"
          },
          optional: [
            { frameRate: 10 },
            { facingMode: "environment" }
          ]
        },
        'audio': false
      },
      function(stream) {
        if (navigator.mozGetUserMedia) {
          video.mozSrcObject = stream;
        } else {
          var vendorURL = window.URL || window.webkitURL;
          video.src = vendorURL.createObjectURL(stream);
        }
        video.play();
      },
      function(err) {
        console.log("An error occured! " + err);
      }
    );

    video.addEventListener(
      'canplay',
      function(ev) {
        if (!streaming) {
          streaming = true;

          console.log('live.html w=' + video.videoWidth + ' h=' + video.videoHeight);

          var reader_video = new barcode.reader({
            'source': video,
            'interval': 100, // ms
            'threshold': 255,
            'symbology': 'ean13'
          });

          reader_video.start();
        }
      },
      false
    );

  </script>

</html>
